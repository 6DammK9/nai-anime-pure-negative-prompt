> python batch_nlp_caption.py --parquet_path "F:/danbooru2024-webp-4Mpixel/metadata.parquet" --device "cuda:0" --prompt_threads 6 --img_dir "F:/danbooru2024-webp-4Mpixel/kohyas_finetune/" --in_json "F:/tipo-toriigate-runtime/split_files/missing_0.json" --out_json_good "F:/tipo-toriigate-runtime/split_files/meta_cap_2024_toriigate_good_0.json" --out_json_bad "F:/tipo-toriigate-runtime/split_files/meta_cap_2024_toriigate_bad_0.json" 
Preparing the tagging database
Preparing the targeted ids
Preparing caption model
`Qwen2VLRotaryEmbedding` can now be fully parameterized by passing the model config through the `config` argument. All other arguments will be removed in v4.46
Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:28<00:00,  7.15s/it]
preparing prompts
making prompt messages: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7453/7453 [00:18<00:00, 396.53it/s]
sorting
making caption:   0%|▌                                                                                                                                                        | 27/7453 [06:08<24:51:07, 12.05s/it]
Invalid JSON in 7868416
making caption:   2%|██▋                                                                                                                                                     | 134/7453 [30:00<25:07:18, 12.36s/it]
Invalid JSON in 7875648
making caption:   2%|███▎                                                                                                                                                    | 163/7453 [36:47<34:45:53, 17.17s/it]
Invalid JSON in 7877568
making caption:   3%|████▎                                                                                                                                                   | 211/7453 [49:21<30:48:15, 15.31s/it]
Invalid JSON in 7880832
making caption:   4%|█████▍                                                                                                                                                | 273/7453 [1:03:49<22:44:32, 11.40s/it]
Invalid JSON in 7884992
making caption:   4%|█████▉                                                                                                                                                | 298/7453 [1:10:08<26:52:00, 13.52s/it]
Invalid JSON in 7886656
making caption:   5%|███████▉                                                                                                                                              | 394/7453 [1:32:29<22:59:05, 11.72s/it]
Invalid JSON in 7892992
making caption:   6%|████████▎                                                                                                                                             | 413/7453 [1:36:43<22:28:01, 11.49s/it]
Invalid JSON in 7894208
making caption:   6%|█████████▍                                                                                                                                            | 466/7453 [1:49:31<27:05:53, 13.96s/it]
Invalid JSON in 7897664
making caption:   7%|█████████▊                                                                                                                                            | 487/7453 [1:54:32<23:00:10, 11.89s/it]
Invalid JSON in 7899072
making caption:   7%|██████████▏                                                                                                                                           | 508/7453 [1:59:30<30:26:07, 15.78s/it]
Invalid JSON in 7900544
making caption:   7%|██████████▉                                                                                                                                           | 544/7453 [2:08:16<24:53:02, 12.97s/it]
Invalid JSON in 7903040
making caption:   8%|███████████▍                                                                                                                                          | 569/7453 [2:14:28<26:25:23, 13.82s/it]
Invalid JSON in 7904704
making caption:   8%|███████████▌                                                                                                                                          | 577/7453 [2:16:52<28:46:29, 15.07s/it]
Invalid caption fragment (dict) in 7905216: {'japanese_text': '15話 ありがとうございました!!'}
making caption:   8%|████████████▋                                                                                                                                         | 629/7453 [2:30:06<24:49:46, 13.10s/it]
Invalid JSON in 7908864
making caption:   9%|████████████▊                                                                                                                                         | 634/7453 [2:31:40<29:14:11, 15.44s/it]
Invalid caption fragment (dict) in 7909184: {'top_left': '*Normal Brain*', 'bottom_left': '*Ass Spotted*'}
making caption:  11%|████████████████▉                                                                                                                                     | 841/7453 [3:17:20<28:33:04, 15.55s/it]
Invalid JSON in 7923136
making caption:  12%|█████████████████▍                                                                                                                                    | 865/7453 [3:23:48<33:29:50, 18.30s/it]
Invalid JSON in 7924736
making caption:  14%|████████████████████▊                                                                                                                                | 1040/7453 [4:05:12<21:27:39, 12.05s/it]
Invalid caption fragment (dict) in 7936320: {'1st_frame': 'You find the place alright? You got here pretty quick. Uhm, what? X-you mean... are you a cop?', '2nd_frame': "Why don't you have a seat. I'm in the wrong place. Sorry, I'd better leave.", '3rd_frame': 'Have a seat right over here!'}
making caption:  15%|█████████████████████▉                                                                                                                               | 1098/7453 [4:17:05<20:06:21, 11.39s/it]
Invalid JSON in 7940224
making caption:  15%|██████████████████████▍                                                                                                                              | 1121/7453 [4:23:17<21:37:18, 12.29s/it]
Invalid caption fragment (dict) in 7941760: {'text_1': 'why dis', 'text_2': 'look so mad', 'text_3': 'crying emoji'}
making caption:  15%|██████████████████████▊                                                                                                                              | 1143/7453 [4:28:24<25:37:52, 14.62s/it]
Invalid JSON in 7943168
making caption:  18%|██████████████████████████▋                                                                                                                          | 1335/7453 [5:10:30<19:29:39, 11.47s/it]
Invalid JSON in 7955776
making caption:  18%|███████████████████████████                                                                                                                          | 1351/7453 [5:14:50<19:12:58, 11.34s/it]
Invalid JSON in 7956800
making caption:  18%|███████████████████████████▎                                                                                                                         | 1369/7453 [5:20:04<24:16:17, 14.36s/it]
Invalid JSON in 7958016
making caption:  19%|███████████████████████████▌                                                                                                                         | 1380/7453 [5:23:09<27:35:57, 16.36s/it]
Invalid caption fragment (dict) in 7958720: {'character_1': 'A fiery inferno surrounds the Reaper, with orange and red flames licking at the ground. The sky is a deep black, contrasting sharply with the intense fire. The overall impression is one of chaos and destruction.', 'character_2': 'The background is dark and shadowy, with a deep crimson hue dominating the upper portion. The lighting is focused on the character, creating a dramatic contrast between light and shadow.'}
making caption:  22%|████████████████████████████████▍                                                                                                                    | 1623/7453 [6:18:38<21:04:15, 13.01s/it]
Invalid JSON in 7974720
making caption:  22%|████████████████████████████████▊                                                                                                                    | 1641/7453 [6:22:43<17:16:26, 10.70s/it]
Invalid JSON in 7975872
making caption:  24%|███████████████████████████████████▋                                                                                                                 | 1782/7453 [6:54:43<16:32:43, 10.50s/it]
Invalid JSON in 7985216
making caption:  26%|██████████████████████████████████████▎                                                                                                              | 1917/7453 [7:27:59<18:40:09, 12.14s/it]
Invalid JSON in 7994112
making caption:  30%|████████████████████████████████████████████▊                                                                                                        | 2244/7453 [8:41:40<22:55:20, 15.84s/it]
Invalid text bubble dict in 8015488
making caption:  32%|███████████████████████████████████████████████▊                                                                                                     | 2390/7453 [9:15:35<26:16:55, 18.69s/it]
Invalid JSON in 8025344
making caption:  32%|████████████████████████████████████████████████▍                                                                                                    | 2420/7453 [9:23:01<17:01:58, 12.18s/it]
Invalid JSON in 8027328
making caption:  36%|█████████████████████████████████████████████████████▎                                                                                              | 2685/7453 [10:23:33<18:44:46, 14.15s/it]
Invalid JSON in 8044736
making caption:  37%|██████████████████████████████████████████████████████▌                                                                                             | 2745/7453 [10:37:27<12:06:35,  9.26s/it]
Invalid text bubble dict in 8048832
making caption:  37%|██████████████████████████████████████████████████████▋                                                                                             | 2755/7453 [10:40:01<20:05:56, 15.40s/it]
Invalid text bubble dict in 8049472
making caption:  39%|█████████████████████████████████████████████████████████                                                                                           | 2871/7453 [11:05:36<16:25:54, 12.91s/it]
Invalid JSON in 8057344
making caption:  40%|██████████████████████████████████████████████████████████▋                                                                                         | 2957/7453 [11:24:30<22:15:53, 17.83s/it]
Invalid JSON in 8062976
making caption:  40%|███████████████████████████████████████████████████████████▌                                                                                        | 3002/7453 [11:36:25<18:19:36, 14.82s/it]
Invalid text bubble dict in 8065984
making caption:  41%|████████████████████████████████████████████████████████████▊                                                                                       | 3063/7453 [11:49:45<15:07:24, 12.40s/it]
Invalid JSON in 8069952
making caption:  42%|██████████████████████████████████████████████████████████████▎                                                                                     | 3140/7453 [12:07:54<17:29:58, 14.61s/it]
Invalid JSON in 8075136
making caption:  42%|██████████████████████████████████████████████████████████████▌                                                                                     | 3151/7453 [12:10:46<18:00:50, 15.07s/it]
Invalid JSON in 8075840
making caption:  43%|███████████████████████████████████████████████████████████████▎                                                                                    | 3189/7453 [12:18:04<14:43:53, 12.44s/it]
Invalid JSON in 8078336
making caption:  43%|████████████████████████████████████████████████████████████████                                                                                    | 3226/7453 [12:25:48<13:04:12, 11.13s/it]
Invalid JSON in 8080832
making caption:  44%|████████████████████████████████████████████████████████████████▊                                                                                   | 3262/7453 [12:34:50<20:05:11, 17.25s/it]
Invalid JSON in 8083264
making caption:  44%|████████████████████████████████████████████████████████████████▊                                                                                   | 3265/7453 [12:36:16<26:49:31, 23.06s/it]
Invalid JSON in 8083456
making caption:  45%|███████████████████████████████████████████████████████████████████▏                                                                                | 3381/7453 [13:02:40<11:39:31, 10.31s/it]
Invalid JSON in 8091008
making caption:  46%|████████████████████████████████████████████████████████████████████▏                                                                               | 3432/7453 [13:14:44<13:52:25, 12.42s/it]
Invalid JSON in 8094336
making caption:  46%|████████████████████████████████████████████████████████████████████▌                                                                               | 3453/7453 [13:19:35<11:05:47,  9.99s/it]
Invalid JSON in 8095680
making caption:  48%|██████████████████████████████████████████████████████████████████████▉                                                                             | 3573/7453 [13:47:16<12:29:38, 11.59s/it]
Invalid JSON in 8103680
making caption:  49%|███████████████████████████████████████████████████████████████████████▊                                                                            | 3615/7453 [13:57:11<12:23:32, 11.62s/it]
Invalid JSON in 8106432
making caption:  49%|████████████████████████████████████████████████████████████████████████▎                                                                           | 3640/7453 [14:03:03<14:23:26, 13.59s/it]
Invalid JSON in 8108096
making caption:  53%|██████████████████████████████████████████████████████████████████████████████▍                                                                     | 3950/7453 [15:09:54<12:57:28, 13.32s/it]
Invalid text bubble list in 8128448
[{'text': 'Too gentle...', 'location': "Speech bubble above Naegi's head."}, {'text': 'Naegi, you can hold my hand if you want.', 'location': "Speech bubble above Kirigiri's head."}, {'text': 'Whaddyasay?', 'location': 'Speech bubble to the right of Kirigiri.'}, {'text': 'SQUEEZE', 'location': 'Speech bubble between the two characters.'}]
making caption:  54%|███████████████████████████████████████████████████████████████████████████████▌                                                                    | 4008/7453 [15:22:52<13:25:01, 14.02s/it]
Invalid JSON in 8132352
making caption:  55%|████████████████████████████████████████████████████████████████████████████████▊                                                                   | 4067/7453 [15:36:45<12:33:06, 13.35s/it]
Invalid JSON in 8136320
making caption:  57%|███████████████████████████████████████████████████████████████████████████████████▊                                                                | 4221/7453 [16:13:07<14:56:23, 16.64s/it]
Invalid JSON in 8146752
making caption:  57%|████████████████████████████████████████████████████████████████████████████████████                                                                | 4233/7453 [16:16:35<13:06:18, 14.65s/it]
Invalid JSON in 8147520
making caption:  57%|████████████████████████████████████████████████████████████████████████████████████▋                                                               | 4266/7453 [16:24:06<10:57:41, 12.38s/it]
Invalid JSON in 8149824
making caption:  57%|████████████████████████████████████████████████████████████████████████████████████▊                                                               | 4269/7453 [16:25:20<16:07:08, 18.22s/it]
Invalid JSON in 8150016
making caption:  57%|████████████████████████████████████████████████████████████████████████████████████▊                                                               | 4271/7453 [16:26:21<20:38:03, 23.34s/it]
Invalid JSON in 8150144
making caption:  59%|███████████████████████████████████████████████████████████████████████████████████████▉                                                            | 4429/7453 [17:02:15<13:04:22, 15.56s/it]
Invalid JSON in 8160512
making caption:  61%|█████████████████████████████████████████████████████████████████████████████████████████▋                                                          | 4516/7453 [17:22:31<11:51:38, 14.54s/it]
Invalid JSON in 8166272
making caption:  61%|██████████████████████████████████████████████████████████████████████████████████████████                                                          | 4534/7453 [17:27:18<10:22:31, 12.80s/it]
Invalid JSON in 8167488
making caption:  61%|██████████████████████████████████████████████████████████████████████████████████████████▋                                                         | 4566/7453 [17:36:04<12:32:11, 15.63s/it]
Invalid caption fragment (dict) in 8169536: {'character_1': 'Brandish @naru_FT', 'character_2': 'Lucy @neri_w2'}
making caption:  62%|████████████████████████████████████████████████████████████████████████████████████████████▍                                                        | 4623/7453 [17:48:04<9:17:41, 11.82s/it]
Invalid JSON in 8173376
making caption:  62%|████████████████████████████████████████████████████████████████████████████████████████████▍                                                       | 4652/7453 [17:55:52<10:45:16, 13.82s/it]
Invalid JSON in 8175296
making caption:  63%|█████████████████████████████████████████████████████████████████████████████████████████████▋                                                       | 4688/7453 [18:03:51<8:19:39, 10.84s/it]
Invalid JSON in 8177600
making caption:  66%|█████████████████████████████████████████████████████████████████████████████████████████████████▎                                                  | 4898/7453 [18:54:07<12:41:19, 17.88s/it]
Invalid text bubble dict in 8191616
making caption:  66%|██████████████████████████████████████████████████████████████████████████████████████████████████▋                                                  | 4937/7453 [19:02:45<7:32:29, 10.79s/it]
Invalid JSON in 8194176
making caption:  67%|███████████████████████████████████████████████████████████████████████████████████████████████████▍                                                 | 4972/7453 [19:11:34<9:38:01, 13.98s/it]
Invalid JSON in 8196608
making caption:  67%|████████████████████████████████████████████████████████████████████████████████████████████████████                                                 | 5007/7453 [19:20:11<8:36:30, 12.67s/it]
Invalid JSON in 8198912
making caption:  68%|████████████████████████████████████████████████████████████████████████████████████████████████████▉                                                | 5049/7453 [19:29:47<7:56:14, 11.89s/it]
Invalid JSON in 8201600
making caption:  68%|████████████████████████████████████████████████████████████████████████████████████████████████████▉                                               | 5084/7453 [19:38:10<10:52:21, 16.52s/it]
Invalid text bubble list in 8203968
[{'text': 'W-WHEN DID YOU GET HERE?', 'bbox': [10, 10, 160, 100]}, {'text': 'THIS BLUE GUY CALLED ME.', 'bbox': [10, 600, 160, 100]}]
making caption:  69%|█████████████████████████████████████████████████████████████████████████████████████████████████████▍                                              | 5111/7453 [19:44:55<11:02:05, 16.96s/it]
Invalid JSON in 8205696
making caption:  69%|██████████████████████████████████████████████████████████████████████████████████████████████████████▌                                              | 5128/7453 [19:48:50<7:05:33, 10.98s/it]
Invalid text bubble dict in 8206912
making caption:  70%|███████████████████████████████████████████████████████████████████████████████████████████████████████▋                                             | 5185/7453 [20:02:09<7:46:24, 12.34s/it]
Invalid JSON in 8210880
making caption:  71%|█████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                           | 5262/7453 [20:21:33<9:39:10, 15.86s/it]
Invalid JSON in 8216128
making caption:  71%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                          | 5314/7453 [20:33:26<7:23:05, 12.43s/it]
Invalid JSON in 8219456
making caption:  72%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▋                                          | 5338/7453 [20:39:22<6:13:26, 10.59s/it]
Invalid JSON in 8220992
making caption:  72%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                          | 5347/7453 [20:41:59<9:13:22, 15.77s/it]
Invalid JSON in 8221632
making caption:  72%|███████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                         | 5371/7453 [20:48:10<7:11:26, 12.43s/it]
Invalid JSON in 8223168
making caption:  73%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                       | 5473/7453 [21:11:42<7:10:04, 13.03s/it]
Invalid JSON in 8229888
making caption:  74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                      | 5519/7453 [21:21:27<6:28:40, 12.06s/it]
Invalid JSON in 8232832
making caption:  74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                      | 5530/7453 [21:24:32<5:43:47, 10.73s/it]
Invalid caption fragment (dict) in 8233600: {'win': "The word 'WIN' is written in a stylized font in the upper left corner, with a crown symbol above it.", 'lose': "The word 'LOSE' is written in a stylized font in the upper right corner."}
making caption:  75%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                     | 5563/7453 [21:31:51<7:31:19, 14.33s/it]
Invalid JSON in 8235712
making caption:  75%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                     | 5566/7453 [21:33:05<10:00:33, 19.10s/it]
Invalid JSON in 8235904
making caption:  77%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                  | 5725/7453 [22:09:34<6:57:21, 14.49s/it]
Invalid JSON in 8246464
making caption:  77%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                 | 5763/7453 [22:18:15<6:44:41, 14.37s/it]
Invalid JSON in 8248896
making caption:  77%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                 | 5769/7453 [22:19:46<5:19:28, 11.38s/it]
Invalid JSON in 8249344
making caption:  78%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                 | 5777/7453 [22:22:00<6:34:42, 14.13s/it]
Invalid JSON in 8249856
making caption:  79%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                               | 5871/7453 [22:43:52<5:10:02, 11.76s/it]
Invalid JSON in 8256064
making caption:  79%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                               | 5872/7453 [22:44:35<9:18:28, 21.19s/it]
Invalid JSON in 8256128
making caption:  82%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                          | 6125/7453 [23:40:59<5:06:57, 13.87s/it]
Invalid JSON in 8272704
making caption:  83%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                         | 6169/7453 [23:52:05<4:22:13, 12.25s/it]
Invalid JSON in 8275648
making caption:  83%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                        | 6222/7453 [24:04:42<4:09:33, 12.16s/it]
Invalid JSON in 8279104
making caption:  84%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                        | 6241/7453 [24:09:26<4:51:09, 14.41s/it]
Invalid JSON in 8280320
making caption:  84%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                        | 6244/7453 [24:10:36<6:11:13, 18.42s/it]
Invalid JSON in 8280512
making caption:  85%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                      | 6328/7453 [24:31:06<4:27:23, 14.26s/it]
Invalid JSON in 8286144
making caption:  85%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                      | 6332/7453 [24:32:44<6:08:10, 19.71s/it]
Invalid JSON in 8286400
making caption:  86%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                    | 6412/7453 [24:53:21<4:26:33, 15.36s/it]
Invalid JSON in 8291776
making caption:  86%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                    | 6436/7453 [24:59:59<4:24:56, 15.63s/it]
Invalid JSON in 8293312
making caption:  89%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                | 6609/7453 [25:40:45<3:31:20, 15.02s/it]
Invalid caption fragment (dict) in 8304768: {'1008': "The number '1008' is written in the upper left corner.", 'momoharu day': "The words 'momoharu day' are written in the upper right corner."}
making caption:  89%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                | 6637/7453 [25:47:25<3:14:11, 14.28s/it]
Invalid JSON in 8306560
making caption:  90%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉               | 6702/7453 [26:02:38<3:04:38, 14.75s/it]
Invalid JSON in 8311040
making caption:  92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎            | 6821/7453 [26:30:45<2:11:38, 12.50s/it]
Invalid JSON in 8318912
making caption:  92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌            | 6831/7453 [26:33:30<2:15:01, 13.03s/it]
Invalid JSON in 8319552
making caption:  92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊            | 6846/7453 [26:37:36<2:22:22, 14.07s/it]
Invalid JSON in 8320640
making caption:  93%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌          | 6929/7453 [26:57:06<2:19:09, 15.93s/it]
Invalid JSON in 8326080
making caption:  94%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌        | 7032/7453 [27:21:47<1:26:06, 12.27s/it]
Invalid JSON in 8332800
making caption:  96%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████      | 7154/7453 [27:50:25<1:16:44, 15.40s/it]
Invalid JSON in 8340800
making caption:  97%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍    | 7225/7453 [28:06:11<56:44, 14.93s/it]
Invalid JSON in 8345600
making caption:  98%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊   | 7293/7453 [28:22:30<31:21, 11.76s/it]
Invalid JSON in 8350080
making caption:  98%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉   | 7301/7453 [28:24:31<30:03, 11.86s/it]
Invalid text bubble dict in 8350592
making caption:  98%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋  | 7337/7453 [28:32:35<26:51, 13.89s/it]
Invalid JSON in 8352960
making caption: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7453/7453 [29:00:03<00:00, 14.01s/it]
Outputing JSON
Dump complete.