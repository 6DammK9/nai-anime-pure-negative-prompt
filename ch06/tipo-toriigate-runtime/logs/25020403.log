>python batch_nlp_caption.py --parquet_path "F:/danbooru2024-webp-4Mpixel/metadata.parquet" --device "cuda:1" --prompt_threads 6 --img_dir "F:/danbooru2024-webp-4Mpixel/kohyas_finetune/" --in_json "F:/tipo-toriigate-runtime/split_files/missing_1.json" --out_json_good "F:/tipo-toriigate-runtime/split_files/meta_cap_2024_toriigate_good_1.json" --out_json_bad "F:/tipo-toriigate-runtime/split_files/meta_cap_2024_toriigate_bad_1.json" 
Preparing the tagging database
Preparing the targeted ids
Preparing caption model
`Qwen2VLRotaryEmbedding` can now be fully parameterized by passing the model config through the `config` argument. All other arguments will be removed in v4.46
Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:12<00:00,  3.07s/it]
preparing prompts
making prompt messages: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7495/7495 [00:19<00:00, 381.77it/s]
sorting
making caption:   0%|▏                                                                                                                                                         | 9/7495 [02:05<29:53:24, 14.37s/it]
Invalid JSON in 7867009
making caption:   0%|▋                                                                                                                                                        | 35/7495 [11:19<40:49:43, 19.70s/it]
Invalid JSON in 7868801
making caption:   1%|█                                                                                                                                                        | 53/7495 [17:02<39:20:25, 19.03s/it]
Invalid JSON in 7870017
making caption:   4%|██████▏                                                                                                                                               | 308/7495 [1:31:05<26:40:15, 13.36s/it]
Invalid JSON in 7886721
making caption:   5%|███████▉                                                                                                                                              | 394/7495 [1:57:05<34:19:07, 17.40s/it]
Invalid JSON in 7892353
making caption:   6%|████████▎                                                                                                                                             | 413/7495 [2:03:11<41:37:12, 21.16s/it]
Invalid JSON in 7893569
making caption:   6%|█████████▋                                                                                                                                            | 481/7495 [2:23:29<39:04:06, 20.05s/it]
Invalid JSON in 7898049
making caption:   7%|██████████▋                                                                                                                                           | 533/7495 [2:38:56<32:56:49, 17.04s/it]
Invalid JSON in 7901569
making caption:   8%|████████████                                                                                                                                          | 603/7495 [3:00:06<38:42:51, 20.22s/it]
Invalid JSON in 7906177
making caption:   9%|█████████████▋                                                                                                                                        | 681/7495 [3:22:13<28:50:33, 15.24s/it]
Invalid JSON in 7911553
making caption:  11%|████████████████▋                                                                                                                                     | 835/7495 [4:08:33<37:46:40, 20.42s/it]
Invalid JSON in 7921857
making caption:  13%|███████████████████▍                                                                                                                                  | 971/7495 [4:51:25<37:25:40, 20.65s/it]
Invalid JSON in 7930753
making caption:  17%|████████████████████████▌                                                                                                                            | 1237/7495 [6:09:58<27:12:00, 15.65s/it]
Invalid JSON in 7948097
making caption:  18%|██████████████████████████▏                                                                                                                          | 1318/7495 [6:33:53<30:22:32, 17.70s/it]
Invalid text bubble list in 7953409
[{'text': 'IDC', 'location': "Speech bubble above Gazpacho's head"}, {'text': "U CAN'T DO THAT", 'location': "Speech bubble above Dib's head"}, {'text': 'Ur So Mean', 'location': "Speech bubble next to Dib's head"}]
making caption:  19%|████████████████████████████▍                                                                                                                        | 1433/7495 [7:09:44<27:37:33, 16.41s/it]
Invalid JSON in 7961089
making caption:  20%|██████████████████████████████▍                                                                                                                      | 1534/7495 [7:40:04<33:06:33, 20.00s/it]
Invalid JSON in 7967937
making caption:  21%|██████████████████████████████▋                                                                                                                      | 1544/7495 [7:43:31<28:35:10, 17.29s/it]
Invalid caption fragment (dict) in 7968577: {'text_1': '君は一体何者なんだ…！', 'text_2': 'オレは…オレさ…'}
making caption:  21%|███████████████████████████████▉                                                                                                                     | 1605/7495 [8:02:04<21:52:46, 13.37s/it]
Invalid caption fragment (dict) in 7972609: {'number': '82', 'japanese': '82 ぱっつの日'}
making caption:  26%|██████████████████████████████████████▏                                                                                                              | 1919/7495 [9:32:47<20:42:58, 13.37s/it]
Invalid JSON in 7993089
making caption:  26%|███████████████████████████████████████                                                                                                              | 1964/7495 [9:46:58<26:44:56, 17.41s/it]
Invalid JSON in 7996097
making caption:  26%|███████████████████████████████████████▍                                                                                                             | 1986/7495 [9:54:13<21:28:31, 14.03s/it]
Invalid JSON in 7997505
making caption:  28%|████████████████████████████████████████▊                                                                                                           | 2068/7495 [10:16:47<20:43:57, 13.75s/it]
Invalid JSON in 8002817
making caption:  29%|██████████████████████████████████████████▎                                                                                                         | 2143/7495 [10:39:16<24:09:17, 16.25s/it]
Invalid JSON in 8007745
making caption:  29%|██████████████████████████████████████████▊                                                                                                         | 2167/7495 [10:47:36<34:48:16, 23.52s/it]
Invalid caption fragment (dict) in 8009281: {'top': 'ご視聴ありがとうございました！', 'bottom': 'イラスト: 伊藤麻由加'}
making caption:  30%|███████████████████████████████████████████▋                                                                                                        | 2215/7495 [11:01:19<28:43:55, 19.59s/it]
Invalid JSON in 8012353
making caption:  31%|██████████████████████████████████████████████▍                                                                                                     | 2351/7495 [11:43:26<24:27:00, 17.11s/it]
Invalid JSON in 8021313
making caption:  32%|███████████████████████████████████████████████▏                                                                                                    | 2387/7495 [11:55:11<27:14:48, 19.20s/it]
Invalid JSON in 8023617
making caption:  32%|████████████████████████████████████████████████                                                                                                    | 2435/7495 [12:10:16<28:03:54, 19.97s/it]
Invalid JSON in 8026753
making caption:  33%|████████████████████████████████████████████████▊                                                                                                   | 2470/7495 [12:21:39<32:15:29, 23.11s/it]
Invalid JSON in 8029057
making caption:  33%|█████████████████████████████████████████████████▍                                                                                                  | 2503/7495 [12:32:47<27:51:28, 20.09s/it]
Invalid JSON in 8031233
making caption:  34%|█████████████████████████████████████████████████▉                                                                                                  | 2528/7495 [12:40:41<26:12:01, 18.99s/it]
Invalid JSON in 8032897
making caption:  34%|██████████████████████████████████████████████████▏                                                                                                 | 2544/7495 [12:46:19<26:36:49, 19.35s/it]
Invalid JSON in 8033921
making caption:  35%|███████████████████████████████████████████████████▎                                                                                                | 2600/7495 [13:02:51<22:30:48, 16.56s/it]
Invalid JSON in 8037633
making caption:  35%|███████████████████████████████████████████████████▉                                                                                                | 2628/7495 [13:11:22<19:37:05, 14.51s/it]
Invalid JSON in 8039489
making caption:  35%|████████████████████████████████████████████████████                                                                                                | 2636/7495 [13:15:01<28:18:37, 20.97s/it]
Invalid JSON in 8040001
making caption:  35%|████████████████████████████████████████████████████▎                                                                                               | 2651/7495 [13:19:55<17:02:13, 12.66s/it]
Invalid JSON in 8040961
making caption:  37%|██████████████████████████████████████████████████████                                                                                              | 2739/7495 [13:47:44<23:32:10, 17.82s/it]
Invalid JSON in 8047041
making caption:  37%|██████████████████████████████████████████████████████▌                                                                                             | 2765/7495 [13:55:34<17:58:26, 13.68s/it]
Invalid text bubble dict in 8048833
making caption:  37%|██████████████████████████████████████████████████████▊                                                                                             | 2776/7495 [13:58:27<19:52:08, 15.16s/it]
Invalid JSON in 8049537
making caption:  40%|███████████████████████████████████████████████████████████▎                                                                                        | 3003/7495 [15:05:21<17:31:32, 14.05s/it]
Invalid JSON in 8064449
making caption:  42%|██████████████████████████████████████████████████████████████▍                                                                                     | 3164/7495 [15:51:15<20:07:33, 16.73s/it]
Invalid JSON in 8074817
making caption:  43%|███████████████████████████████████████████████████████████████▍                                                                                    | 3213/7495 [16:06:22<17:26:20, 14.66s/it]
Invalid JSON in 8077953
making caption:  43%|███████████████████████████████████████████████████████████████▌                                                                                    | 3217/7495 [16:08:21<27:54:03, 23.48s/it]
Invalid JSON in 8078209
making caption:  43%|███████████████████████████████████████████████████████████████▊                                                                                    | 3230/7495 [16:13:08<24:08:09, 20.37s/it]
Invalid JSON in 8079041
making caption:  44%|█████████████████████████████████████████████████████████████████▌                                                                                  | 3321/7495 [16:39:51<24:54:28, 21.48s/it]
Invalid JSON in 8085185
making caption:  46%|███████████████████████████████████████████████████████████████████▊                                                                                | 3436/7495 [17:14:11<18:43:00, 16.60s/it]
Invalid JSON in 8092673
making caption:  48%|███████████████████████████████████████████████████████████████████████▌                                                                            | 3626/7495 [18:11:30<17:36:53, 16.39s/it]
Invalid JSON in 8105089
making caption:  49%|████████████████████████████████████████████████████████████████████████                                                                            | 3647/7495 [18:17:42<16:44:02, 15.66s/it]
Invalid JSON in 8106497
making caption:  49%|████████████████████████████████████████████████████████████████████████▎                                                                           | 3663/7495 [18:22:57<14:51:08, 13.95s/it]
Invalid JSON in 8107585
making caption:  49%|█████████████████████████████████████████████████████████████████████████▏                                                                          | 3709/7495 [18:37:37<19:00:49, 18.08s/it]
Invalid caption fragment (dict) in 8110529: {'top_panel': 'A bright, softly lit room with a window visible in the background. The window is slightly out of focus, suggesting a shallow depth of field. There are indistinct shapes that could be books or other objects on a shelf.', 'bottom_panel': 'A muted, slightly darker background with a subtle gradient. There are small, light particles scattered throughout, giving a soft, ethereal feel. The background is less detailed than the top panel.'}
making caption:  50%|█████████████████████████████████████████████████████████████████████████▉                                                                          | 3743/7495 [18:47:04<13:10:17, 12.64s/it]
Invalid JSON in 8112833
making caption:  51%|███████████████████████████████████████████████████████████████████████████▋                                                                        | 3836/7495 [19:13:32<22:31:57, 22.17s/it]
Invalid caption fragment (dict) in 8118977: {'shrimp_tempura': 'Several pieces of shrimp tempura are arranged on a small, square, gray plate. They are golden-brown and appear crispy, with visible sesame seeds on top.', 'corn_dog': 'A corn dog is also on the plate, with a stick inserted into it. It has a similar golden-brown color and texture to the shrimp tempura.', 'sauce': 'A small, rectangular container of sauce is placed to the left of the plate. The sauce appears dark brown and thick.', 'plate': 'The food is served on a small, gray, square plate with a slightly textured surface, resembling a griddle or a small tray.'}       
making caption:  52%|█████████████████████████████████████████████████████████████████████████████▎                                                                      | 3913/7495 [19:35:17<11:43:12, 11.78s/it]
Invalid JSON in 8124097
making caption:  53%|██████████████████████████████████████████████████████████████████████████████▉                                                                     | 3996/7495 [19:59:42<14:28:06, 14.89s/it]
Invalid JSON in 8129409
making caption:  54%|███████████████████████████████████████████████████████████████████████████████▉                                                                    | 4047/7495 [20:15:24<15:45:39, 16.46s/it]
Invalid JSON in 8132865
making caption:  56%|██████████████████████████████████████████████████████████████████████████████████▋                                                                 | 4186/7495 [20:56:56<18:50:56, 20.51s/it]
Invalid JSON in 8141953
making caption:  56%|██████████████████████████████████████████████████████████████████████████████████▊                                                                 | 4193/7495 [20:59:35<18:38:57, 20.33s/it]
Invalid JSON in 8142401
making caption:  57%|████████████████████████████████████████████████████████████████████████████████████▌                                                               | 4282/7495 [21:26:49<18:16:36, 20.48s/it]
Invalid JSON in 8148289
making caption:  57%|████████████████████████████████████████████████████████████████████████████████████▉                                                               | 4304/7495 [21:33:32<14:39:33, 16.54s/it]
Invalid JSON in 8149825
making caption:  59%|███████████████████████████████████████████████████████████████████████████████████████▍                                                            | 4431/7495 [22:10:52<11:24:58, 13.41s/it]
Invalid JSON in 8158465
making caption:  59%|███████████████████████████████████████████████████████████████████████████████████████▋                                                            | 4443/7495 [22:15:06<14:44:07, 17.38s/it]
Invalid JSON in 8159233
making caption:  64%|███████████████████████████████████████████████████████████████████████████████████████████████                                                     | 4813/7495 [24:03:43<13:44:58, 18.46s/it]
Invalid JSON in 8183809
making caption:  65%|████████████████████████████████████████████████████████████████████████████████████████████████▎                                                   | 4876/7495 [24:22:45<15:46:02, 21.67s/it]
Invalid JSON in 8187905
making caption:  67%|███████████████████████████████████████████████████████████████████████████████████████████████████▏                                                | 5024/7495 [25:09:01<15:56:17, 23.22s/it]
Invalid JSON in 8197633
making caption:  67%|███████████████████████████████████████████████████████████████████████████████████████████████████▍                                                | 5033/7495 [25:12:14<11:34:01, 16.91s/it]
Invalid JSON in 8198209
making caption:  67%|███████████████████████████████████████████████████████████████████████████████████████████████████▌                                                | 5043/7495 [25:15:38<12:38:30, 18.56s/it]
Invalid JSON in 8198913
making caption:  68%|████████████████████████████████████████████████████████████████████████████████████████████████████▌                                               | 5095/7495 [25:31:11<12:07:15, 18.18s/it]
Invalid caption fragment (dict) in 8202305: {'1st_frame': "Our god's Chosen? Why did you kill your own brother?", '2nd_frame': "Lady Orin, why... I don't understand...", '3rd_frame': 'To measure my abilities.'}   
making caption:  68%|████████████████████████████████████████████████████████████████████████████████████████████████████▋                                               | 5102/7495 [25:33:24<12:29:09, 18.78s/it]
Invalid JSON in 8202817
making caption:  68%|█████████████████████████████████████████████████████████████████████████████████████████████████████▎                                              | 5131/7495 [25:42:48<12:26:06, 18.94s/it]
Invalid JSON in 8204673
making caption:  72%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                          | 5378/7495 [26:55:47<9:10:02, 15.59s/it]
Invalid JSON in 8221121
making caption:  72%|██████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                         | 5380/7495 [26:57:12<16:27:23, 28.01s/it]
Invalid JSON in 8221249
making caption:  72%|███████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                         | 5411/7495 [27:06:59<8:52:48, 15.34s/it]
Invalid JSON in 8223297
making caption:  73%|███████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                        | 5445/7495 [27:18:25<10:17:39, 18.08s/it]
Invalid JSON in 8225473
making caption:  73%|████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                                        | 5468/7495 [27:25:29<8:52:54, 15.77s/it]
Invalid JSON in 8226945
making caption:  73%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                       | 5504/7495 [27:36:29<7:07:13, 12.87s/it]
Invalid JSON in 8229313
making caption:  74%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                       | 5513/7495 [27:39:28<8:18:30, 15.09s/it]
Invalid JSON in 8229889
making caption:  74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                                      | 5545/7495 [27:50:01<9:08:28, 16.88s/it]
Invalid JSON in 8232065
making caption:  74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                      | 5555/7495 [27:53:32<9:32:46, 17.71s/it]
Invalid JSON in 8232705
making caption:  75%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                     | 5606/7495 [28:08:55<7:18:35, 13.93s/it]
Invalid JSON in 8236097
making caption:  75%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                                     | 5633/7495 [28:16:37<7:18:37, 14.13s/it]
Invalid JSON in 8237953
making caption:  75%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                    | 5649/7495 [28:22:19<9:19:45, 18.19s/it]
Invalid caption fragment (dict) in 8238977: {'top_panel': 'The top panel shows a dark, metallic wall with a small, rectangular window. The window shows a blurry, indistinct view of what appears to be a cloudy sky or a hazy landscape.', 'bottom_panel': 'The bottom panel has a vibrant pink background with some darker pink and red streaks, creating a somewhat abstract and dynamic feel. The background is less defined than the characters, drawing focus to them.'}
Invalid caption fragment (dict) in 8238977: {'top_panel': 'The text at the top of the image is in Japanese and is not translated.', 'bottom_panel': 'The text at the bottom of the image is in Japanese and reads: "彼女の優しさと死に誓って…絶対にだっ!"'}
making caption:  76%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                                   | 5706/7495 [28:39:59<10:22:49, 20.89s/it]
Invalid JSON in 8242817
making caption:  78%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                | 5839/7495 [29:20:07<10:58:12, 23.85s/it]
Invalid text bubble dict in 8251777
making caption:  80%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                             | 5996/7495 [30:06:51<6:40:56, 16.05s/it]
Invalid JSON in 8262273
making caption:  82%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                           | 6139/7495 [30:48:15<4:50:41, 12.86s/it]
Invalid JSON in 8271617
making caption:  82%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                          | 6166/7495 [30:56:56<6:19:59, 17.16s/it]
Invalid text bubble dict in 8273473
making caption:  83%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                        | 6256/7495 [31:23:52<5:02:12, 14.63s/it]
Invalid caption fragment (dict) in 8279425: {'1st_frame': "YOU HAVE LEGS AND HANDS, WHY DON'T YOU DO IT YOURSELF?", '2nd_frame': "BECAUSE I KNOW IF I ASK, YOU'LL DO IT.", '3rd_frame': "WHY DO I HAVE LEGS AND HANDS & I CAN'T GO GET FOODS MYSELF?", '4th_frame': 'AT LEAST SOME THINGS NEVER CHANGE...'}
making caption:  85%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                      | 6382/7495 [32:02:54<4:19:12, 13.97s/it]
Invalid text bubble dict in 8287809
making caption:  88%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                 | 6597/7495 [33:09:48<4:46:30, 19.14s/it]
Invalid JSON in 8301697
making caption:  88%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                 | 6604/7495 [33:12:51<5:36:04, 22.63s/it]
Invalid JSON in 8302145
making caption:  89%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                | 6654/7495 [33:29:02<4:53:07, 20.91s/it]
Invalid JSON in 8305409
making caption:  89%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                | 6655/7495 [33:30:02<7:34:30, 32.46s/it]
Invalid JSON in 8305473
making caption:  90%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌               | 6719/7495 [33:49:44<3:22:43, 15.68s/it]
Invalid JSON in 8309761
making caption:  90%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏              | 6749/7495 [33:58:02<3:38:04, 17.54s/it]
Invalid JSON in 8311745
making caption:  92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌            | 6867/7495 [34:33:36<2:39:06, 15.20s/it]
Invalid JSON in 8319425
making caption:  92%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████            | 6895/7495 [34:42:39<3:10:15, 19.03s/it]
Invalid JSON in 8321345
making caption:  93%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎          | 6960/7495 [35:01:59<2:29:38, 16.78s/it]
Invalid JSON in 8325569
making caption:  93%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌          | 6967/7495 [35:04:31<2:41:17, 18.33s/it]
Invalid JSON in 8326017
making caption:  93%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌          | 6970/7495 [35:06:01<3:16:31, 22.46s/it]
Invalid JSON in 8326273
making caption:  94%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋         | 7029/7495 [35:24:38<2:24:58, 18.67s/it]
Invalid JSON in 8330049
making caption:  94%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████         | 7044/7495 [35:29:25<2:21:07, 18.77s/it]
Invalid JSON in 8331009
making caption:  96%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌      | 7169/7495 [36:06:01<1:07:28, 12.42s/it]
Invalid JSON in 8339201
making caption:  98%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌  | 7375/7495 [37:08:59<33:23, 16.69s/it]
Invalid JSON in 8352641
making caption:  98%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋  | 7380/7495 [37:11:17<40:51, 21.32s/it]
Invalid JSON in 8353025
making caption:  99%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏| 7456/7495 [37:36:13<11:56, 18.37s/it]
Invalid JSON in 8357889
making caption: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7495/7495 [37:49:00<00:00, 18.16s/it]
Outputing JSON
Dump complete.