>python batch_nlp_caption.py --parquet_path "F:/danbooru2024-webp-4Mpixel/metadata.parquet" --device "cuda:2" --prompt_threads 6 --img_dir "F:/danbooru2024-webp-4Mpixel/kohyas_finetune/" --in_json "F:/tipo-toriigate-runtime/split_files/missing_2.json" --out_json_good "F:/tipo-toriigate-runtime/split_files/meta_cap_2024_toriigate_good_2.json" --out_json_bad "F:/tipo-toriigate-runtime/split_files/meta_cap_2024_toriigate_bad_2.json" 
Preparing the tagging database
Preparing the targeted ids
Preparing caption model
`Qwen2VLRotaryEmbedding` can now be fully parameterized by passing the model config through the `config` argument. All other arguments will be removed in v4.46
Loading checkpoint shards: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:12<00:00,  3.14s/it]
preparing prompts
making prompt messages: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7498/7498 [00:19<00:00, 382.31it/s]
sorting
making caption:   1%|█                                                                                                                                                        | 50/7498 [14:05<29:03:33, 14.05s/it]
Invalid JSON in 7869954
making caption:   2%|██▍                                                                                                                                                     | 118/7498 [34:30<35:41:26, 17.41s/it]
Invalid text bubble dict in 7874434
making caption:   2%|██▊                                                                                                                                                     | 137/7498 [39:23<32:01:57, 15.67s/it]
Invalid JSON in 7875842
making caption:   6%|████████▍                                                                                                                                             | 424/7498 [2:03:08<36:27:43, 18.56s/it]
Invalid JSON in 7894594
making caption:   7%|█████████▊                                                                                                                                            | 490/7498 [2:22:42<38:03:01, 19.55s/it]
Invalid JSON in 7898882
making caption:   7%|██████████▏                                                                                                                                           | 511/7498 [2:28:55<31:20:09, 16.15s/it]
Invalid JSON in 7900354
making caption:   8%|███████████▍                                                                                                                                          | 572/7498 [2:47:15<34:45:09, 18.06s/it]
Invalid JSON in 7904322
making caption:  10%|███████████████▏                                                                                                                                      | 761/7498 [3:40:23<24:29:20, 13.09s/it]
Invalid JSON in 7916546
making caption:  15%|██████████████████████▋                                                                                                                              | 1142/7498 [5:32:11<30:47:09, 17.44s/it]
Invalid JSON in 7941954
making caption:  17%|█████████████████████████▍                                                                                                                           | 1278/7498 [6:11:17<28:27:38, 16.47s/it]
Invalid JSON in 7951042
making caption:  19%|████████████████████████████▉                                                                                                                        | 1459/7498 [7:02:07<33:41:40, 20.09s/it]
Invalid JSON in 7962882
making caption:  21%|███████████████████████████████▊                                                                                                                     | 1603/7498 [7:42:26<29:18:05, 17.89s/it]
Invalid JSON in 7972354
making caption:  22%|█████████████████████████████████▍                                                                                                                   | 1681/7498 [8:05:28<25:18:15, 15.66s/it]
Invalid JSON in 7977410
making caption:  22%|█████████████████████████████████▍                                                                                                                   | 1683/7498 [8:06:31<35:07:02, 21.74s/it]
Invalid JSON in 7977538
making caption:  24%|███████████████████████████████████▋                                                                                                                 | 1793/7498 [8:38:19<30:51:30, 19.47s/it]
Invalid JSON in 7984642
making caption:  24%|████████████████████████████████████▎                                                                                                                | 1827/7498 [8:48:56<29:49:01, 18.93s/it]
Invalid JSON in 7986882
making caption:  26%|██████████████████████████████████████▍                                                                                                              | 1934/7498 [9:19:37<24:46:55, 16.03s/it]
Invalid JSON in 7994114
making caption:  26%|██████████████████████████████████████▊                                                                                                              | 1954/7498 [9:25:21<24:56:53, 16.20s/it]
Invalid JSON in 7995458
making caption:  28%|█████████████████████████████████████████▎                                                                                                          | 2091/7498 [10:04:54<20:34:37, 13.70s/it]
Invalid JSON in 8004546
making caption:  29%|██████████████████████████████████████████▌                                                                                                         | 2159/7498 [10:24:02<32:20:16, 21.80s/it]
Invalid JSON in 8009026
making caption:  29%|██████████████████████████████████████████▊                                                                                                         | 2167/7498 [10:27:29<31:36:53, 21.35s/it]
Invalid JSON in 8009602
making caption:  29%|███████████████████████████████████████████▍                                                                                                        | 2199/7498 [10:37:22<24:55:02, 16.93s/it]
Invalid JSON in 8011778
making caption:  31%|█████████████████████████████████████████████▎                                                                                                      | 2296/7498 [11:06:20<19:01:30, 13.17s/it]
Invalid JSON in 8018050
making caption:  32%|███████████████████████████████████████████████▋                                                                                                    | 2413/7498 [11:40:08<29:49:43, 21.12s/it]
Invalid JSON in 8025858
making caption:  32%|███████████████████████████████████████████████▉                                                                                                    | 2430/7498 [11:45:59<26:51:25, 19.08s/it]
Invalid JSON in 8027010
making caption:  33%|████████████████████████████████████████████████▌                                                                                                   | 2459/7498 [11:54:30<22:57:05, 16.40s/it]
Invalid JSON in 8028866
making caption:  33%|█████████████████████████████████████████████████▏                                                                                                  | 2495/7498 [12:04:22<17:26:45, 12.55s/it]
Invalid JSON in 8031170
making caption:  35%|███████████████████████████████████████████████████▍                                                                                                | 2604/7498 [12:37:10<26:02:58, 19.16s/it]
Invalid JSON in 8038338
making caption:  36%|████████████████████████████████████████████████████▉                                                                                               | 2683/7498 [13:00:32<23:29:17, 17.56s/it]
Invalid text bubble dict in 8043714
making caption:  37%|██████████████████████████████████████████████████████▍                                                                                             | 2757/7498 [13:23:09<19:41:01, 14.95s/it]
Invalid JSON in 8048834
making caption:  37%|██████████████████████████████████████████████████████▋                                                                                             | 2770/7498 [13:27:44<25:41:36, 19.56s/it]
Invalid JSON in 8049666
making caption:  37%|███████████████████████████████████████████████████████▍                                                                                            | 2810/7498 [13:40:14<26:48:38, 20.59s/it]
Invalid JSON in 8052418
making caption:  38%|████████████████████████████████████████████████████████                                                                                            | 2840/7498 [13:49:04<23:29:33, 18.16s/it]
Invalid JSON in 8054466
making caption:  40%|██████████████████████████████████████████████████████████▋                                                                                         | 2973/7498 [14:28:12<24:43:49, 19.67s/it]
Invalid JSON in 8063234
making caption:  40%|██████████████████████████████████████████████████████████▋                                                                                         | 2976/7498 [14:29:53<33:38:51, 26.79s/it]
Invalid JSON in 8063426
making caption:  41%|████████████████████████████████████████████████████████████▍                                                                                       | 3065/7498 [14:55:18<24:41:43, 20.05s/it]
Invalid JSON in 8069122
making caption:  43%|███████████████████████████████████████████████████████████████▍                                                                                    | 3214/7498 [15:38:47<20:40:02, 17.37s/it]
Invalid JSON in 8079042
making caption:  43%|████████████████████████████████████████████████████████████████▏                                                                                   | 3249/7498 [15:50:58<22:53:31, 19.40s/it]
Invalid JSON in 8081282
making caption:  43%|████████████████████████████████████████████████████████████████▎                                                                                   | 3261/7498 [15:54:57<16:54:11, 14.36s/it]
Invalid JSON in 8082050
making caption:  45%|██████████████████████████████████████████████████████████████████▉                                                                                 | 3393/7498 [16:32:52<21:26:09, 18.80s/it]
Invalid JSON in 8090562
making caption:  48%|██████████████████████████████████████████████████████████████████████▍                                                                             | 3569/7498 [17:23:28<18:33:06, 17.00s/it]
Invalid JSON in 8102082
making caption:  49%|███████████████████████████████████████████████████████████████████████▊                                                                            | 3641/7498 [17:42:46<18:17:04, 17.07s/it]
Invalid JSON in 8106818
making caption:  49%|████████████████████████████████████████████████████████████████████████▏                                                                           | 3655/7498 [17:47:52<20:00:03, 18.74s/it]
Invalid JSON in 8107778
making caption:  50%|█████████████████████████████████████████████████████████████████████████▍                                                                          | 3721/7498 [18:06:01<15:36:20, 14.87s/it]
Invalid JSON in 8112194
making caption:  51%|███████████████████████████████████████████████████████████████████████████                                                                         | 3802/7498 [18:28:51<15:16:54, 14.88s/it]
Invalid JSON in 8117570
making caption:  51%|███████████████████████████████████████████████████████████████████████████▉                                                                        | 3845/7498 [18:41:07<18:40:15, 18.40s/it]
Invalid text bubble dict in 8120322
making caption:  53%|██████████████████████████████████████████████████████████████████████████████▊                                                                     | 3991/7498 [19:22:03<14:18:04, 14.68s/it]
Invalid JSON in 8129922
making caption:  53%|███████████████████████████████████████████████████████████████████████████████                                                                     | 4006/7498 [19:26:17<12:03:37, 12.43s/it]
Invalid JSON in 8130882
making caption:  54%|███████████████████████████████████████████████████████████████████████████████▌                                                                    | 4032/7498 [19:34:06<17:27:04, 18.13s/it]
Invalid JSON in 8132546
making caption:  54%|████████████████████████████████████████████████████████████████████████████████                                                                    | 4053/7498 [19:40:44<16:27:50, 17.20s/it]
Invalid text bubble dict in 8133890
making caption:  57%|█████████████████████████████████████████████████████████████████████████████████████                                                               | 4309/7498 [20:55:36<15:47:39, 17.83s/it]
Invalid JSON in 8150850
making caption:  59%|██████████████████████████████████████████████████████████████████████████████████████▉                                                             | 4406/7498 [21:24:12<12:56:19, 15.06s/it]
Invalid JSON in 8157442
making caption:  60%|█████████████████████████████████████████████████████████████████████████████████████████▍                                                          | 4528/7498 [21:58:19<15:33:36, 18.86s/it]
Invalid JSON in 8165570
making caption:  61%|█████████████████████████████████████████████████████████████████████████████████████████▌                                                          | 4537/7498 [22:01:17<12:57:11, 15.75s/it]
Invalid JSON in 8166146
making caption:  61%|█████████████████████████████████████████████████████████████████████████████████████████▋                                                          | 4546/7498 [22:04:37<15:06:46, 18.43s/it]
Invalid JSON in 8166722
making caption:  62%|████████████████████████████████████████████████████████████████████████████████████████████                                                        | 4666/7498 [22:39:48<15:57:17, 20.28s/it]
Invalid JSON in 8174658
making caption:  63%|█████████████████████████████████████████████████████████████████████████████████████████████▍                                                       | 4702/7498 [22:50:35<9:43:14, 12.52s/it]
Invalid JSON in 8177026
making caption:  66%|██████████████████████████████████████████████████████████████████████████████████████████████████▋                                                  | 4965/7498 [24:04:44<8:49:32, 12.54s/it]
Invalid text bubble list in 8194370
[{'text': 'Hey, this is our apartment, can you glfo.', 'location': "Speech bubble above Scott Pilgrim's head."}, {'text': 'Do I not get a soy in this..', 'location': "Thought bubble above Wallace Wells' head."}, 
{'text': 'You Call this shack an apartment??', 'location': "Speech bubble above Wallace Wells' head."}, {'text': 'Maybe if he comes with me he could be in an actual livable place.', 'location': "Speech bubble above Todd Ingram's head."}]
making caption:  68%|████████████████████████████████████████████████████████████████████████████████████████████████████▍                                               | 5088/7498 [24:38:53<14:44:52, 22.03s/it]
Invalid JSON in 8202626
making caption:  68%|█████████████████████████████████████████████████████████████████████████████████████████████████████▎                                              | 5134/7498 [24:53:21<14:32:24, 22.14s/it]
Invalid text bubble dict in 8205634
making caption:  69%|██████████████████████████████████████████████████████████████████████████████████████████████████████▎                                             | 5185/7498 [25:07:42<12:22:01, 19.25s/it]
Invalid JSON in 8208898
making caption:  69%|██████████████████████████████████████████████████████████████████████████████████████████████████████▍                                             | 5192/7498 [25:10:08<10:49:54, 16.91s/it]
Invalid JSON in 8209410
making caption:  70%|███████████████████████████████████████████████████████████████████████████████████████████████████████▌                                             | 5212/7498 [25:16:18<9:03:40, 14.27s/it]
Invalid text bubble dict in 8210754
making caption:  70%|████████████████████████████████████████████████████████████████████████████████████████████████████████▊                                            | 5277/7498 [25:33:32<8:41:34, 14.09s/it]
Invalid JSON in 8215042
making caption:  73%|████████████████████████████████████████████████████████████████████████████████████████████████████████████                                         | 5438/7498 [26:19:30<9:02:34, 15.80s/it]
Invalid text bubble dict in 8225538
making caption:  73%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████                                        | 5489/7498 [26:34:11<9:05:24, 16.29s/it]
Invalid JSON in 8228930
making caption:  73%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                       | 5504/7498 [26:38:48<9:04:55, 16.40s/it]
Invalid JSON in 8229890
making caption:  74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████▌                                      | 5565/7498 [26:57:26<7:47:04, 14.50s/it]
Invalid JSON in 8233858
making caption:  74%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████                                      | 5574/7498 [27:00:36<10:35:07, 19.81s/it]
Invalid JSON in 8234434
making caption:  76%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                   | 5698/7498 [27:36:50<10:10:43, 20.36s/it]
Invalid caption fragment (dict) in 8242754: {'text_1': 'よろしく\nおねがい\nします！', 'text_2': 'なが'}
making caption:  77%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                                 | 5808/7498 [28:06:54<8:50:36, 18.84s/it]
Invalid JSON in 8250114
making caption:  79%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                               | 5900/7498 [28:34:01<9:23:04, 21.14s/it]
Invalid JSON in 8256194
making caption:  81%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                            | 6094/7498 [29:28:01<6:10:49, 15.85s/it]
Invalid JSON in 8268866
making caption:  83%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                         | 6201/7498 [30:00:55<5:06:21, 14.17s/it]
Invalid JSON in 8275906
making caption:  86%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                    | 6461/7498 [31:13:24<4:31:17, 15.70s/it]
Invalid JSON in 8292930
making caption:  87%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                    | 6495/7498 [31:23:39<4:08:53, 14.89s/it]
Invalid JSON in 8295234
making caption:  87%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏                   | 6498/7498 [31:25:07<6:07:42, 22.06s/it]
Invalid JSON in 8295426
making caption:  87%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍                   | 6514/7498 [31:30:22<4:58:17, 18.19s/it]
Invalid JSON in 8296450
making caption:  87%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                   | 6534/7498 [31:36:58<5:32:22, 20.69s/it]
Invalid JSON in 8297794
making caption:  87%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                  | 6556/7498 [31:43:59<4:40:49, 17.89s/it]
Invalid JSON in 8299202
making caption:  88%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉                  | 6586/7498 [31:53:00<4:25:40, 17.48s/it]
Invalid caption fragment (dict) in 8301186: {'copyright': '©2019 Disney-Lucasfilm Press', 'artist': 'TARA-PHILLIPS.COM'}
making caption:  94%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊        | 7083/7498 [34:15:58<1:42:04, 14.76s/it]
Invalid JSON in 8333634
making caption:  95%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉        | 7090/7498 [34:18:23<1:49:58, 16.17s/it]
Invalid JSON in 8334082
making caption:  95%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▉       | 7144/7498 [34:33:49<1:52:00, 18.99s/it]
Invalid JSON in 8337538
making caption:  96%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▌     | 7227/7498 [34:59:20<1:15:42, 16.76s/it]
Invalid JSON in 8342914
making caption:  97%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▍    | 7268/7498 [35:11:20<1:07:00, 17.48s/it]
Invalid caption fragment (dict) in 8345602: {'top_text': '"你是许下什么愿望 成为魔法少女的？"', 'bottom_text': '...'}
making caption:  98%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▏  | 7360/7498 [35:36:12<32:37, 14.18s/it]
Invalid JSON in 8351554
making caption:  99%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊  | 7387/7498 [35:44:29<37:21, 20.19s/it]
Invalid JSON in 8353282
making caption: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7498/7498 [36:17:02<00:00, 17.42s/it]
Outputing JSON
Dump complete.